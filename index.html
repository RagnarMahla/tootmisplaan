// --- UUENDATUD ABIFUNKTSIOONID TÄPSEKS KUUPÄEVA ARVUTAMISEKS ---
function parseDate(d) {
    const date = new Date(d);
    // Seame kellaaja päeva keskele, et vältida ajavööndi nihkeid
    return new Date(date.getFullYear(), date.getMonth(), date.getDate(), 12, 0, 0);
}

function getDayDiff(d1, d2) {
    const t1 = parseDate(d1).getTime();
    const t2 = parseDate(d2).getTime();
    return Math.round((t1 - t2) / 86400000);
}

function renderGantt(containerId, key) {
    const outer = document.getElementById(containerId);
    const dayCount = 180;
    const startViewFixed = parseDate(START_VIEW); // Alguspunkt 01.01.2026
    
    let headerHtml = `<div class="gantt-header-wrapper">
        <div class="header-corner">MT / Klient / Aeg</div>
        <div class="header-scroll" id="h-scroll-${key}">
            <div class="header-grid">`;
            
    for(let d=0; d<dayCount; d+=7) headerHtml += `<div style="grid-column:span 7; background:#dfe4ea; text-align:center; font-size:11px; border-bottom:1px solid #ccc; padding:3px 0; border-right:1px solid #ccc;">W${getWeek(new Date(startViewFixed.getTime() + d*86400000))}</div>`;
    
    for(let d=0; d<dayCount; d++) {
        let cur = new Date(startViewFixed.getTime() + d*86400000);
        let isT = cur.toDateString() === TODAY.toDateString();
        headerHtml += `<div style="text-align:center; font-size:9px; padding:5px 0; border-right:1px solid #eee; ${isT?'background:rgba(255,71,87,0.3); font-weight:bold;':''}">${cur.getDate()}.${cur.getMonth()+1}</div>`;
    }
    headerHtml += `</div></div></div>`;

    let bodyHtml = `<div class="gantt-body" id="b-scroll-${key}">`;
    let tIdx = getDayDiff(TODAY, startViewFixed);
    let todayLineLeft = (tIdx * 45) + 22;

    orders.filter(o => o[key] > 0).forEach((o) => {
        let gIdx = orders.indexOf(o);
        // TÄPNE START JA KESTVUS
        let sIdx = getDayDiff(o.start, startViewFixed);
        let dur = getDayDiff(o.end, o.start) + 1;

        bodyHtml += `<div class="gantt-row">
            <div class="gantt-info">
                <b>${o.mt||'MT'}</b><small>${o.client||'-'}</small>
                <div style="display:flex;gap:3px;">
                    <input type="date" value="${cd(o.start)}" onchange="u(${gIdx},'start',this.value);renderGantt('${containerId}','${key}')">
                    <input type="date" value="${cd(o.end)}" onchange="u(${gIdx},'end',this.value);renderGantt('${containerId}','${key}')">
                </div>
            </div>
            <div class="gantt-bars-wrapper">
                <div class="today-line" style="left:${todayLineLeft}px"></div>`;
        
        // Joonistame riba ainult siis, kui see jääb vaatevälja
        if(sIdx >= 0 && sIdx < dayCount) {
            bodyHtml += `<div class="task-bar" style="left:${sIdx * 45}px; width:${dur * 45 - 5}px">
                <div class="progress-fill" style="width:${o.progress}%"></div>
                <span style="position:relative; padding-left:5px;">${o.mt} (${o.progress}%)</span>
            </div>`;
        }
        
        for(let d=0; d<dayCount; d++) {
            let cur = new Date(startViewFixed.getTime() + d*86400000);
            bodyHtml += `<div class="grid-cell ${cur.toDateString()===TODAY.toDateString()?'today-col':''}"></div>`;
        }
        bodyHtml += `</div></div>`;
    });
    outer.innerHTML = headerHtml + bodyHtml + `</div>`;

    const hScroll = document.getElementById(`h-scroll-${key}`);
    const bScroll = document.getElementById(`b-scroll-${key}`);
    bScroll.onscroll = () => { hScroll.scrollLeft = bScroll.scrollLeft; };
    setTimeout(() => { bScroll.scrollLeft = (tIdx * 45) - (bScroll.offsetWidth / 2) + 160; }, 150);
}
